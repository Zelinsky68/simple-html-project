name: Build and Deploy with Kind

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ› ï¸ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ³ Set up Docker
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸš€ Set up Kind
      uses: container-tools/kind-action@v1
      with:
        version: v0.20.0
    
    - name: ğŸ“¦ Create Kind Cluster
      run: |
        kind create cluster --name github-ci --wait 5m
        kubectl cluster-info --context kind-github-ci
        
    - name: ğŸ—ï¸ Build Docker Image
      run: |
        docker build -t simple-html-app:latest .
        
    - name: ğŸ“¤ Load Image to Kind
      run: |
        kind load docker-image simple-html-app:latest --name github-ci
        
    - name: ğŸš€ Deploy Application
      run: |
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚ Ğ´Ğ»Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: html-content
        data:
          index.html: |
            $(cat index.html)
        ---
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: simple-html-app
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: simple-html
          template:
            metadata:
              labels:
                app: simple-html
            spec:
              containers:
              - name: web
                image: simple-html-app:latest
                imagePullPolicy: Never  # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ·
                ports:
                - containerPort: 80
                volumeMounts:
                - name: html-volume
                  mountPath: /usr/share/nginx/html
              volumes:
              - name: html-volume
                configMap:
                  name: html-content
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: simple-html-service
        spec:
          selector:
            app: simple-html
          ports:
          - port: 80
            targetPort: 80
          type: ClusterIP
        EOF
        
        # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¿Ğ¾Ğ´Ğ°
        kubectl wait --for=condition=ready pod -l app=simple-html --timeout=120s
        
        echo "âœ… Deployment completed!"
        kubectl get all
        
    - name: ğŸ§ª Run Tests
      run: |
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
        kubectl run test --image=alpine/curl --restart=Never --rm -i -- curl -s http://simple-html-service | head -20
        
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        kind delete cluster --name github-ci
