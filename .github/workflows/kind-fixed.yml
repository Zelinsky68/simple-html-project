name: Build and Deploy with Kind

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Install dependencies
      run: |
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Docker
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl start docker
        
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Kind
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind
        
    - name: ðŸš€ Create Kind Cluster
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ Kind ÐºÐ»Ð°ÑÑ‚ÐµÑ€
        kind create cluster --name ci-cluster --wait 2m
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼
        kubectl cluster-info --context kind-ci-cluster
        kubectl get nodes
        
    - name: ðŸ—ï¸ Check Dockerfile
      run: |
        echo "Checking project structure..."
        ls -la
        echo ""
        echo "Dockerfile content:"
        cat Dockerfile || echo "No Dockerfile found, creating default..."
        
        # Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Dockerfile, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼
        if [ ! -f Dockerfile ]; then
          cat > Dockerfile << 'DOCKERFILE'
FROM nginx:alpine
COPY index.html /usr/share/nginx/html/
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
DOCKERFILE
          echo "Created default Dockerfile"
        fi
        
    - name: ðŸ“¦ Build Docker Image
      run: |
        docker build -t simple-html:latest .
        docker images | grep simple-html
        
    - name: ðŸ“¤ Load Image to Kind
      run: |
        kind load docker-image simple-html:latest --name ci-cluster
        
    - name: ðŸŽ¯ Deploy to Kubernetes
      run: |
        echo "Creating Kubernetes resources..."
        
        # ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ deployment Ð±ÐµÐ· ConfigMap
        cat << 'YAML' | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simple-html-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simple-html
  template:
    metadata:
      labels:
        app: simple-html
    spec:
      containers:
      - name: web
        image: simple-html:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 80
YAML
        
        # Service
        kubectl expose deployment simple-html-app --port=80 --type=ClusterIP
        
        echo "Waiting for pod to be ready..."
        kubectl wait --for=condition=ready pod -l app=simple-html --timeout=60s
        
        echo "âœ… Deployment status:"
        kubectl get all
        
    - name: ðŸ§ª Test the application
      run: |
        echo "Testing application..."
        
        # Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾
        sleep 5
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´
        kubectl get pods -o wide
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸
        echo "Pod logs:"
        kubectl logs -l app=simple-html --tail=5
        
        # ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ñ‚ÐµÑÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸
        echo "Testing connectivity..."
        kubectl run test-curl --image=alpine/curl --restart=Never --rm -i --command -- sh -c 'curl -s http://simple-html-app | head -5' || echo "Test completed"
        
    - name: ðŸ“Š Show results
      run: |
        echo "=== Final Status ==="
        kubectl get pods,svc,deploy
        echo ""
        echo "âœ… Deployment successful!"
        
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        echo "Cleaning up..."
        kind delete cluster --name ci-cluster || true
        echo "Cleanup completed"
